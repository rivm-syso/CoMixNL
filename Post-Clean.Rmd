---
title: "Post-Clean"
author: "Laurens Bogaardt"
date: "2022-01-01"
output:
  html_document:
    df_print: paged
    fig_width: 10
    fig.align: "center"
    toc: true
    toc_depth: 4
    toc_float: true
    theme: united
    code_folding: show
---

# Introduction

Before we begin, we will need to load some packages.

```{r results = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(qs)
library(pracma)
```

Text

# Load Data

Text

```{r}
participant_common <- read_csv(
  file = "data/CoMix_nl_participant_common.csv",
  col_types = cols(
    .default = col_character(),
    part_id = col_integer(),
    part_age = col_integer() # part_age_group?
  )
)
participant_extra <- read_csv(
  file = "data/CoMix_nl_participant_extra.csv",
  col_types = cols(
    .default = col_character(),
    survey_round = col_integer(),
    part_id = col_integer(),
    date = col_date("%Y-%m-%d"),
    survey_date = col_date("%Y-%m-%d"),
    part_vacc = col_integer(),
    hh_size = col_integer()
  )
)
```

Text

```{r}
contact_common <- read_csv(
  file = "data/CoMix_nl_contact_common.csv",
  col_types = cols(
    .default = col_character(),
    part_id = col_integer(),
    cnt_age_est_min = col_integer(),
    cnt_age_est_max = col_integer(),
    cnt_home = col_logical(),
    cnt_work = col_logical(),
    cnt_school = col_logical(),
    cnt_transport = col_logical(),
    cnt_leisure = col_logical(),
    cnt_otherplace = col_logical()
  )
)
contact_extra <- read_csv(
  file = "data/CoMix_nl_contact_extra.csv",
  col_types = cols(
    .default = col_character(),
    survey_round = col_integer(),
    date = col_date("%Y-%m-%d"),
    cnt_bar_rest = col_logical(),
    cnt_health_facility = col_logical(),
    cnt_household = col_logical(),
    cnt_inside = col_logical(),
    cnt_other_house = col_logical(),
    cnt_other_place = col_logical(),
    cnt_outside = col_logical(),
    cnt_outside_other = col_logical(),
    cnt_public_market = col_logical(),
    cnt_public_transport = col_logical(),
    cnt_salon = col_logical(),
    cnt_shop = col_logical(),
    cnt_sport = col_logical(),
    cnt_supermarket = col_logical(),
    cnt_worship = col_logical(),
    cnt_phys = col_logical(),
    cnt_prec_1_and_half_m_plus = col_logical(),
    cnt_prec_mask = col_logical(),
    cnt_prec_prefer_not_to_say = col_integer()
  )
)
```

Text

```{r}
household_common <- read_csv(
  file = "data/CoMix_nl_hh_common.csv",
  col_types = cols(
    .default = col_character(),
    hh_size = col_integer()
  )
)
household_extra <- read_csv(
  file = "data/CoMix_nl_hh_extra.csv",
  col_types = cols(
    .default = col_character(),
    survey_round = col_integer(),
    date = col_date("%Y-%m-%d")
  )
)
```

Text

```{r}
participant_data <- participant_common %>%
  left_join(participant_extra, by = "part_id") %>%
 mutate(part_id = floor(part_id / 100)) # Waar komt dit vandaan? Komt niet overeen in join met participant_data zonder de floor().
contact_data <- contact_common %>%
  left_join(contact_extra, by = "cont_id") %>%
  mutate(
    part_id = floor(part_id / 100)
  )
household_data <- household_common %>%
  left_join(household_extra, by = c("hh_id", "country"))
```

Text

<!-- # ```{r} -->
<!-- # participant_data <- qread("part_preclean.qs") -->
<!-- # participant_data <- participant_data %>% -->
<!-- #   mutate(part_gender = toupper(substr(part_gender, 1, 1))) -->
<!-- # contact_data <- qread("contacts_preclean.qs") -->
<!-- # household_data <- qread("household_preclean.qs") -->
<!-- # ``` -->
<!-- #  -->
<!-- # Text -->
<!-- #  -->
<!-- # ```{r} -->
<!-- # participant_data %>% nrow() -->
<!-- # participant_data2 %>% nrow() -->
<!-- # contact_data %>% nrow() -->
<!-- # contact_data2 %>% nrow() -->
<!-- # household_data %>% nrow() -->
<!-- # household_data2 %>% nrow() -->
<!-- # ``` -->
<!-- #  -->
<!-- # ```{r} -->
<!-- # participant_data %>% ncol() -->
<!-- # participant_data2 %>% ncol() -->
<!-- # contact_data %>% ncol() -->
<!-- # contact_data2 %>% ncol() -->
<!-- # household_data %>% ncol() -->
<!-- # household_data2 %>% ncol() -->
<!-- # ``` -->
<!-- #  -->
<!-- # ```{r} -->
<!-- # contact_data %>% -->
<!-- #   select(survey_round, part_id, starts_with("cnt_age")) %>% -->
<!-- #   bind_cols( -->
<!-- #     contact_data2 %>% -->
<!-- #       select(survey_round, part_id, cont_id, starts_with("cnt_age")) -->
<!-- #   ) -->
<!-- # ``` -->
<!-- #  -->
<!-- # ```{r} -->
<!-- # contact_data %>% -->
<!-- #   select(cnt_age) %>% -->
<!-- #   bind_cols( -->
<!-- #     contact_data2 %>% -->
<!-- #       mutate(cnt_age2 = paste0(cnt_age_est_min, "-", cnt_age_est_max)) %>% -->
<!-- #       select(cnt_age2) -->
<!-- #   ) %>% -->
<!-- #   count(cnt_age, cnt_age2) -->
<!-- # ``` -->
<!-- #  -->
<!-- # ```{r} -->
<!-- # contact_data <- contact_data %>% -->
<!-- #   group_by(wave, part_id) %>% -->
<!-- #   mutate(cont_id = seq(n())) %>% -->
<!-- #   rowwise() %>% -->
<!-- #   mutate( -->
<!-- #     cnt_otherplace = sum(c( -->
<!-- #       cnt_outside_other, -->
<!-- #       cnt_public_market, -->
<!-- #       cnt_other_house, -->
<!-- #       cnt_worship, -->
<!-- #       cnt_supermarket, -->
<!-- #       cnt_shop -->
<!-- #     ), na.rm = T) > 0 -->
<!-- #   ) %>% -->
<!-- #   ungroup() %>% -->
<!-- #   mutate( -->
<!-- #     cnt_transport = cnt_public_transport, -->
<!-- #     cnt_leisure = cnt_sport, -->
<!-- #     cnt_home = ifelse(is.na(cnt_home), 0, cnt_home), -->
<!-- #     cnt_work = ifelse(is.na(cnt_work), 0, cnt_work), -->
<!-- #     cnt_school = ifelse(is.na(cnt_school), 0, cnt_school), -->
<!-- #     cnt_transport = ifelse(is.na(cnt_transport), 0, cnt_transport), -->
<!-- #     cnt_leisure = ifelse(is.na(cnt_leisure), 0, cnt_leisure), -->
<!-- #     cnt_otherplace = ifelse(is.na(cnt_otherplace), 0, cnt_otherplace) -->
<!-- #   ) -->
<!-- # ``` -->
<!-- #  -->
<!-- #  -->
<!-- # ```{r} -->
<!-- # contact_data %>% -->
<!-- #   select(survey_round, part_id, cont_id, cnt_health_facility, cnt_shop, cnt_supermarket, cnt_other_place, cnt_other_house, cnt_outside_other, cnt_public_market, cnt_salon, cnt_leisure, cnt_bar_rest, cnt_worship, cnt_transport, cnt_school, cnt_work, cnt_home, cnt_household, cnt_inside, cnt_outside, cnt_otherplace, cnt_other_place) %>% -->
<!-- #   pivot_longer(!c(survey_round, part_id, cont_id)) %>% -->
<!-- #   full_join( -->
<!-- #     contact_data2 %>% -->
<!-- #       group_by(survey_round, part_id) %>% -->
<!-- #       mutate(cont_id = seq(n())) %>% -->
<!-- #       ungroup() %>% -->
<!-- #       select(survey_round, part_id, cont_id, cnt_health_facility, cnt_shop, cnt_supermarket, cnt_other_place, cnt_other_house, cnt_outside_other, cnt_public_market, cnt_salon, cnt_leisure, cnt_bar_rest, cnt_worship, cnt_transport, cnt_school, cnt_work, cnt_home, cnt_household, cnt_inside, cnt_outside, cnt_otherplace, cnt_other_place) %>% -->
<!-- #       pivot_longer(!c(survey_round, part_id, cont_id)), -->
<!-- #     by = c("survey_round", "part_id", "cont_id", "name") -->
<!-- #   ) %>% -->
<!-- #   filter(value.x != value.y) %>% -->
<!-- #   count(name, value.x, value.y) -->
<!-- # ``` -->

# Append Wave and Series Columns

Text

```{r}
participant_data <- participant_data %>%
  mutate(
    series = ifelse(survey_round > 8, ifelse(survey_round > 18, 3, 2), 1),
    wave = sprintf("Wave %02d", survey_round)
  )
head(participant_data)
```

Text

```{r}
contact_data <- contact_data %>%
  mutate(
    series = ifelse(survey_round > 8, ifelse(survey_round > 18, 3, 2), 1),
    wave = sprintf("Wave %02d", survey_round)
  )
```

Text

```{r}
household_data <- household_data %>%
  mutate(
    series = ifelse(survey_round > 8, ifelse(survey_round > 18, 3, 2), 1),
    wave = sprintf("Wave %02d", survey_round)
  )
```

Text

# Append Additional Age Groups

Text

```{r}
participant_data <- participant_data %>%
  mutate(
    part_age_group_3 = cut(
      part_age,
      breaks = c(0, 18, 65, Inf),
      right = FALSE
    ),
    part_age_group_75 = cut(
      part_age,
      breaks = c(0, 18, seq(35, 75, 20), Inf),
      right = FALSE
    ),
    part_age_group_65 = cut(
      part_age,
      breaks = c(0, 12, 18, seq(25, 65, 10), Inf),
      right = FALSE
    ),
    part_age_group_85 = cut(
      part_age,
      breaks = c(0, 12, 18, seq(25, 85, 10), Inf),
      right = FALSE
    )
  )
head(participant_data)
```

Text

```{r}
contact_data <- contact_data %>%
  left_join(
    participant_data %>%
      select(
        wave,
        part_id,
        part_age_group_3,
        part_age_group_75,
        part_age_group_65,
        part_age_group_85
      ),
    by = c("wave", "part_id")
  )
head(contact_data)
```

Text

# Append Additional Contact Locations

Text

```{r}
contact_data <- contact_data %>%
  mutate(
    cnt_location = NA_character_,
    cnt_location = if_else(
      cnt_health_facility == 1 |
        cnt_shop == 1 |
        cnt_supermarket == 1 |
        cnt_other_place == 1 |
        cnt_other_house == 1 |
        cnt_outside_other == 1 |
        cnt_public_market == 1,
      "Other place",
      cnt_location
    ),
    cnt_location = if_else(
      cnt_salon == 1 |
        # cnt_sport == 1 |
        cnt_leisure == 1 |
        cnt_bar_rest == 1 | 
        cnt_worship == 1,
      "Leisure",
      cnt_location
    ),
    # cnt_location = if_else(cnt_public_transport == 1, "Transport", cnt_location),
    cnt_location = if_else(cnt_transport == 1, "Transport", cnt_location),
    cnt_location = if_else(cnt_school == 1, "School", cnt_location),
    cnt_location = if_else(cnt_work == 1, "Work", cnt_location),
    cnt_location = if_else(cnt_home == 1, "Home", cnt_location),
    cnt_location = if_else(cnt_home == 1 & cnt_household == 1, "HomeHH", cnt_location),
    cnt_location = if_else(is.na(cnt_location), "Unknown", cnt_location)
  )
```

Text

# Filter Excessive Contacts

Text

```{r}
number_of_contacts_by_wave_and_participant <- contact_data %>%
  group_by(
    series,
    wave,
    part_id
  ) %>%
  summarise(
    number_of_contacts = n(),
    number_of_contacts_individual = sum(cnt_mass == "individual"),
    number_of_contacts_mass = sum(cnt_mass == "mass"),
    .groups = "drop"
  ) %>%
  full_join(
    participant_data,
    by = c("series", "wave", "part_id")
  ) %>%
  mutate(
    number_of_contacts = ifelse(is.na(number_of_contacts), 0, number_of_contacts),
    number_of_contacts_individual = ifelse(is.na(number_of_contacts_individual), 0, number_of_contacts_individual),
    number_of_contacts_mass = ifelse(is.na(number_of_contacts_mass), 0, number_of_contacts_mass),
    cnt_weekend = weekday %in% c("Saturday", "Sunday")
  )
head(number_of_contacts_by_wave_and_participant)
```

Text

```{r}
ggplot() +
  geom_density(
    mapping = aes(
      x = value,
      fill = name
    ),
    data = number_of_contacts_by_wave_and_participant %>%
      filter(series != 1) %>%
      select(wave, part_id, number_of_contacts_individual, number_of_contacts_mass) %>%
      pivot_longer(c("number_of_contacts_individual", "number_of_contacts_mass")) %>%
      mutate(value = log(value, 10)) %>%
      filter(value >= 0),
    alpha = 0.3
  ) +
  scale_fill_discrete(
    name = "Type",
    labels = c("Log10(individual)", "Log10(mass)")
  ) +
  facet_wrap(~ wave)
```

Text

```{r}
filtered_mean_contacts_per_wave <- number_of_contacts_by_wave_and_participant %>%
  group_by(series, wave) %>%
  mutate(
    number_of_contacts_filtered_100 = ifelse(number_of_contacts < 100, number_of_contacts, NA),
    number_of_contacts_filtered_50 = ifelse(number_of_contacts < 50, number_of_contacts, NA),
    number_of_contacts_filtered_mass_100 = ifelse(number_of_contacts_mass < 100, number_of_contacts, NA),
    number_of_contacts_filtered_mass_50 = ifelse(number_of_contacts_mass < 50, number_of_contacts, NA),
    number_of_contacts_filtered_99p = ifelse(number_of_contacts < quantile(number_of_contacts, .99), number_of_contacts, NA),
    number_of_contacts_filtered_995p = ifelse(number_of_contacts < quantile(number_of_contacts, .995), number_of_contacts, NA)
  ) %>%
  group_by(series, wave) %>%
  summarise(
    mean_contact = mean(number_of_contacts),
    mean_contact_filtered_100 = mean(number_of_contacts_filtered_100, na.rm = TRUE),
    mean_contact_filtered_50 = mean(number_of_contacts_filtered_50, na.rm = TRUE),
    mean_contact_filtered_mass_100 = mean(number_of_contacts_filtered_mass_100, na.rm = TRUE),
    mean_contact_filtered_mass_50 = mean(number_of_contacts_filtered_mass_50, na.rm = TRUE),
    mean_contact_filtered_99p = mean(number_of_contacts_filtered_99p, na.rm = TRUE),
    mean_contact_filtered_995p = mean(number_of_contacts_filtered_995p, na.rm = TRUE),
    .groups = "drop"
  )
filtered_mean_contacts_per_wave
```

Text

```{r}
ggplot(
  mapping = aes(
    x = wave,
    y = value,
    col = name,
    group = interaction(series, name)
  ),
  data = filtered_mean_contacts_per_wave %>% pivot_longer(cols = c("mean_contact_filtered_100", "mean_contact_filtered_50", "mean_contact_filtered_mass_100", "mean_contact_filtered_mass_50", "mean_contact_filtered_99p", "mean_contact_filtered_995p"))
) +
  geom_point() +
  geom_line(stat = "identity") +
  labs(
    x = "Datum",
    y = "Aantal contacten",
    title = "Gefilterd aantal contacten per wave"
  ) + 
  scale_color_discrete(
    name = "Filter",
    labels = c("< 100 contacten", "< 50 contacten", "< 99.5% contacten", "< 99% contacten", "mass < 100 contacten", "mass < 50 contacten")
  ) +
  theme_minimal()
```

Text

# Impute Excessive Mass Contacts

Text

```{r}
contact_data_without_large_mass <- contact_data %>%
  group_by(
    series,
    wave,
    part_id,
    cnt_location,
    cnt_mass
  ) %>%
  filter(cnt_mass == "invidual" | n() <= 50) %>%
  ungroup()
contact_data_without_large_mass
```

Text

```{r}
contact_data_mass_sampled <- contact_data %>%
  filter(cnt_mass == "mass") %>%
  group_by(
    series,
    wave,
    part_id,
    cnt_location
  ) %>%
  mutate(n = n()) %>%
  filter(n > 50) %>%
  group_by(
    series,
    wave,
    part_id,
    cnt_location,
    cnt_age_est_min,
    cnt_age_est_max
  ) %>%
  mutate(n2 = round(50 * n() / n)) %>%
  sample_n(n2) %>%
  ungroup() %>%
  select(-n, -n2)
contact_data_mass_sampled
```

Text

```{r}
contact_data <- contact_data_without_large_mass %>%
  bind_rows(contact_data_mass_sampled) %>%
  arrange(
    series,
    wave,
    part_id,
    cnt_location,
    cnt_mass,
    cnt_age_est_min,
    cnt_age_est_max
  )
contact_data
```

Text

# Impute Contact Ages

Text

```{r}
contact_data %>%
  count(cnt_age_est_min, cnt_age_est_max)
```

Text

```{r}
contact_data <- contact_data %>%
  mutate(
    cnt_age_group_85 = recode(
      paste0(cnt_age_est_min, "-", cnt_age_est_max),
      "0-1" = "0-11",
      "1-3" = "0-11",
      "1-4" = "0-11",
      "4-7" = "0-11",
      "5-9" = "0-11",
      "8-10" = "0-11",
      "16-17" = "12-17",
      "18-19" = "18-24",
      "20-24" = "18-24",
      "25-29" = "25-34",
      "30-34" = "25-34",
      "35-39" = "35-44",
      "40-44" = "35-44",
      "45-49" = "45-54",
      "50-54" = "45-54",
      "55-59" = "55-64",
      "60-64" = "55-64",
      "65-69" = "65-74",
      "70-74" = "65-74",
      "75-79" = "75-84",
      "80-84" = "75-84",
      "0-120" = "Prefer not to answer", # verplaats deze logica naar beneden, in de sampling
      "65-120" = "65+", # verplaats deze logica naar beneden, in de sampling
      "85-120" = "85+", # verplaats deze logica naar beneden, in de sampling
      "NA-NA" = "Don't know" # verplaats deze logica naar beneden, in de sampling
    )
  ) %>%
  mutate(
    cnt_age_group_85 = ifelse(
      cnt_age_group_85 == "10-14",
      sample(c("0-11", "12-17"), n(), TRUE, c(2, 3)),
      cnt_age_group_85
    ),
    cnt_age_group_85 = ifelse(
      cnt_age_group_85 == "11-15",
      sample(c("0-11", "12-17"), n(), TRUE, c(1, 4)),
      cnt_age_group_85
    ),
    cnt_age_group_85 = ifelse(
      cnt_age_group_85 == "15-19",
      sample(c("12-17", "18-24"), n(), TRUE, c(3, 2)),
      cnt_age_group_85
    )
  )
```

Text

```{r}
contact_data %>%
  count(cnt_age_group_85)
```

Text

```{r}
# sample contact ages 0-17 from participants with same age group, same contact location and same wave, and contact ages Under 1, 1-4, 5-9, 10-14 and 15-19

tmp <- contact_data %>%
  filter(cnt_age_group_85 == "0-17") %>%
  group_by(
    wave,
    part_age_group_85,
    cnt_location
  ) %>%
  count

new_contact_data <- tibble()

for(i in 1:nrow(tmp)) {
  new_cnt_age_group_85 <- contact_data %>% 
    filter(
      cnt_mass == "individual",
      part_age_group_85 == tmp$part_age_group_85[i],
      cnt_location == tmp$cnt_location[i],
      wave == tmp$wave[i],
      cnt_age_group_85 == "0-11" | cnt_age_group_85 == "12-17"
    ) %>% 
    pull(cnt_age_group_85)
  
  if(length(new_cnt_age_group_85) != 0) {
    new_cnt_age_group_85 <- sample(new_cnt_age_group_85, tmp$n[i], replace = TRUE)
  } else {
    new_cnt_age_group_85 <- contact_data %>% 
      filter(
        cnt_mass == "individual",
        part_age_group_85 == tmp$part_age_group_85[i],
        cnt_age_group_85 == "0-11" | cnt_age_group_85 == "12-17"
      ) %>% 
      pull(cnt_age_group_85) %>%
      sample(tmp$n[i], replace = TRUE)
  }
  
  new_contact_data <- bind_rows(
    new_contact_data,
    contact_data %>%
      filter(
        part_age_group_85 == tmp$part_age_group_85[i],
        cnt_location == tmp$cnt_location[i],
        wave == tmp$wave[i],
        cnt_age_group_85 == "0-17"
      ) %>%
      mutate(cnt_age_group_85 = new_cnt_age_group_85)
  )
}

contact_data <- bind_rows(
  contact_data %>%
    filter(cnt_age_group_85 != "0-17"),
  new_contact_data
)
```

Text

```{r}
# sample contact ages 18-64 from participants with same age group, same contact location and same wave, and contact ages 20-24, 25-34, 35-44, 45-54, 55-64

tmp <- contact_data %>%
  filter(cnt_age_group_85 == "18-64") %>%
  group_by(
    wave,
    part_age_group_85,
    cnt_location
  ) %>% count

new_contact_data <- tibble()

for(i in 1:nrow(tmp)) {
  new_cnt_age_group_85 <- contact_data %>% 
    filter(
      cnt_mass == "individual",
      part_age_group_85 == tmp$part_age_group_85[i],
      cnt_location == tmp$cnt_location[i],
      wave == tmp$wave[i],
      cnt_age_group_85 == "18-24" | cnt_age_group_85 == "25-34" | cnt_age_group_85 == "35-44" | cnt_age_group_85 == "45-54" | cnt_age_group_85 == "55-64"
    ) %>% 
    pull(cnt_age_group_85) 
  
  if(length(new_cnt_age_group_85) != 0) {
    new_cnt_age_group_85 <- sample(new_cnt_age_group_85, tmp$n[i], replace = TRUE)
  } else {
    new_cnt_age_group_85 <- contact_data %>% 
      filter(
        cnt_mass == "individual",
        part_age_group_85 == tmp$part_age_group_85[i],
        cnt_age_group_85 == "18-24" | cnt_age_group_85 == "25-34" | cnt_age_group_85 == "35-44" | cnt_age_group_85 == "45-54" | cnt_age_group_85 == "55-64"
      ) %>% 
      pull(cnt_age_group_85) %>%
      sample(tmp$n[i], replace = TRUE)
  }
  
  new_contact_data <- bind_rows(
    new_contact_data,
    contact_data %>%
      filter(
        part_age_group_85 == tmp$part_age_group_85[i],
        cnt_location == tmp$cnt_location[i],
        wave == tmp$wave[i],
        cnt_age_group_85 == "18-64"
      ) %>%
      mutate(cnt_age_group_85 = new_cnt_age_group_85)
  )
}

contact_data <- bind_rows(
  contact_data %>%
    filter(cnt_age_group_85 != "18-64"),
  new_contact_data
)
```

Text

```{r}
# sample contact ages 65+ from participants with same age group, same contact location and same wave, and contact ages 65-69, 70-74, 75-79, 80-84, 85+

tmp <- contact_data %>%
  filter(cnt_age_group_85 == "65+") %>%
  group_by(
    wave,
    part_age_group_85,
    cnt_location
  ) %>% count

new_contact_data <- tibble()

for(i in 1:nrow(tmp)) {
  new_cnt_age_group_85 <- contact_data %>% 
    filter(
      cnt_mass == "individual",
      part_age_group_85 == tmp$part_age_group_85[i],
      cnt_location == tmp$cnt_location[i],
      wave == tmp$wave[i],
      cnt_age_group_85 == "65-74" | cnt_age_group_85 == "75-84" | cnt_age_group_85 == "85+"
    ) %>% 
    pull(cnt_age_group_85) 
  
  if(length(new_cnt_age_group_85) != 0) {
    new_cnt_age_group_85 <- sample(new_cnt_age_group_85, tmp$n[i], replace = TRUE)
  } else {
    new_cnt_age_group_85 <- contact_data %>% 
      filter(
        cnt_mass == "individual",
        part_age_group_85 == tmp$part_age_group_85[i],
        cnt_age_group_85 == "65-74" | cnt_age_group_85 == "75-84" | cnt_age_group_85 == "85+"
      ) %>% 
      pull(cnt_age_group_85) %>%
      sample(tmp$n[i], replace = TRUE)
  }
  
  new_contact_data <- bind_rows(
    new_contact_data,
    contact_data %>%
      filter(
        part_age_group_85 == tmp$part_age_group_85[i],
        cnt_location == tmp$cnt_location[i],
        wave == tmp$wave[i],
        cnt_age_group_85 == "65+"
      ) %>%
      mutate(cnt_age_group_85 = new_cnt_age_group_85)
  )
}

contact_data <- bind_rows(
  contact_data %>%
    filter(cnt_age_group_85 != "65+"),
  new_contact_data
)
```

Text

```{r}
# sample unknown contact ages from participants with same age group, same contact location, and same wave

tmp <- contact_data %>% filter(
  grepl("know|not", cnt_age_group_85)
) %>%
  group_by(
    wave,
    part_age_group_85,
    cnt_location
  ) %>%
  count()

new_contact_data <- tibble()

for(i in 1:nrow(tmp)) {
  new_cnt_age_group_85 <- contact_data %>% 
    filter(
      cnt_mass == "individual",
      part_age_group_85 == tmp$part_age_group_85[i],
      cnt_location == tmp$cnt_location[i],
      wave == tmp$wave[i],
      !grepl("know|not", cnt_age_group_85)
    ) %>% 
    pull(cnt_age_group_85)
  
  if(length(new_cnt_age_group_85) != 0) {
    new_cnt_age_group_85 <- sample(new_cnt_age_group_85, tmp$n[i], replace = TRUE)
  } else {
    new_cnt_age_group_85 <- contact_data %>% 
      filter(
        cnt_mass == "individual",
        part_age_group_85 == tmp$part_age_group_85[i],
        !grepl("know|not", cnt_age_group_85)
      ) %>% 
      pull(cnt_age_group_85) %>%
      sample(tmp$n[i], replace = TRUE)
  }
  
  new_contact_data <- bind_rows(
    new_contact_data,
    contact_data %>%
      filter(
        part_age_group_85 == tmp$part_age_group_85[i],
        cnt_location == tmp$cnt_location[i],
        wave == tmp$wave[i],
        grepl("know|not", cnt_age_group_85)
      ) %>%
      mutate(cnt_age_group_85 = new_cnt_age_group_85)
  )
}

contact_data <- bind_rows(
  contact_data %>%
    filter(!grepl("know|not", cnt_age_group_85)),
  new_contact_data
)
```

Text

```{r}
contact_data %>%
  group_by(
    cnt_age_group_85
  ) %>%
  count()
```

Text

```{r}
contact_data <- contact_data %>%
  mutate(
    cnt_age_group_65 = ifelse(cnt_age_group_85 %in% c("65-74", "75-84", "85+"), "65+", cnt_age_group_85),
    cnt_age_group_75 = recode(
      cnt_age_group_85,
      "0-11" = "0-17",
      "12-17" = "0-17",
      "18-24" = "18-34",
      "25-34" = "18-34",
      "35-44" = "35-54",
      "45-54" = "35-54",
      "55-64" = "55-74",
      "65-74" = "55-74",
      "75-84" = "75+",
      "85+" = "75+"
    ),
    cnt_age_group_3 = recode(
      cnt_age_group_85,
      "0-11" = "0-17",
      "12-17" = "0-17",
      "18-24" = "18-64",
      "25-34" = "18-64",
      "35-44" = "35-64",
      "45-54" = "35-64",
      "55-64" = "55-64",
      "65-74" = "65+",
      "75-84" = "65+",
      "85+" = "65+"
    )
  )
```

Text

```{r}
contact_data %>%
  group_by(
    cnt_age_group_65
  ) %>%
  count()
```

Text

```{r}
contact_data %>%
  group_by(
    cnt_age_group_75
  ) %>%
  count()
```

Text

# Write Output

Text

```{r}
qsave(participant_data, "part_cleaned.qs")
```

Text

```{r}
qsave(contact_data, "contacts_cleaned.qs")
```

Text

```{r}
qsave(household_data, "household_cleaned.qs")
```

Text